x-tailscale-common: &tailscale-common
  image: tailscale/tailscale:latest
  restart: unless-stopped
  cap_add:
    - net_admin
    - sys_module
  environment:
    TS_EXTRA_ARGS: ${TS_EXTRA_ARGS}
    TS_SERVE_CONFIG: /etc/webserver.json
    TS_AUTHKEY: ${TS_AUTHKEY}

x-tailscale-serve: &tailscale-serve
  <<: *tailscale-common
  configs:
    - source: tailscale_serve_config
      target: /etc/webserver.json

x-tailscale-funnel: &tailscale-funnel
  <<: *tailscale-common
  configs:
    - source: tailscale_funnel_config
      target: /etc/webserver.json

services:
  tailscale-alertmanager:
    <<: *tailscale-serve
    hostname: alertmanager
    container_name: tailscale-alertmanager

  tailscale-grafana:
    <<: *tailscale-serve
    hostname: grafana
    container_name: tailscale-grafana

  tailscale-homeassistant:
    <<: *tailscale-serve
    hostname: homeassistant
    container_name: tailscale-homeassistant

  tailscale-jellyfin:
    <<: *tailscale-serve
    hostname: jellyfin
    container_name: tailscale-jellyfin

  tailscale-victorialogs:
    <<: *tailscale-serve
    hostname: victorialogs
    container_name: tailscale-victorialogs

  tailscale-victoriametrics:
    <<: *tailscale-serve
    hostname: victoriametrics
    container_name: tailscale-victoriametrics

  tailscale-vmalert:
    <<: *tailscale-serve
    hostname: vmalert
    container_name: tailscale-vmalert

  tailscale-zwave:
    <<: *tailscale-serve
    hostname: zwave
    container_name: tailscale-zwave

configs:
  tailscale_serve_config:
    content: |
      {
        "TCP": {"443": {"HTTPS": true}},
        "Web": {
          "$${TS_CERT_DOMAIN}:443": {
            "Handlers": {"/": {"Proxy": "http://caddy:80"}}
          }
        },
        "AllowFunnel": {"$${TS_CERT_DOMAIN}:443": false}
      }

  tailscale_funnel_config:
    content: |
      {
        "TCP": {"443": {"HTTPS": true}},
        "Web": {
          "$${TS_CERT_DOMAIN}:443": {
            "Handlers": {"/": {"Proxy": "http://caddy:80"}}
          }
        },
        "AllowFunnel": {"$${TS_CERT_DOMAIN}:443": true}
      }
